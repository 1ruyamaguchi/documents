# DockerでさまざまなバージョンのJavaに触ってみた

## モチベーション
Javaのバージョンによって次の処理が変わるのか検証したかった。
```
// 数字にnullを仕込んでおく
Integer number = null;
// 数字とnullとが等しいかチェックでfalseを返すかヌルポを返すか検証
try {
    System.out.println(number == 1);
} catch (Exception e) {
    e.printStackTrace();
}
```
Dockerを使ってjavaのバージョン6から11までで上のプログラムを動かしてみる。

## やったこと
### 検証環境
- MacOS: Monterey バージョン12.1
- Docker: version 20.10.8, build 3967b7d

### ディレクトリ構成
```
├── docker
│   └── java
│       └── Dockerfile
├── docker-compose.yml
└── server
    └── src
        ├── Main.class
        └── Main.java
```
（ただしMain.classは後述のコマンド`javac Main.java`を叩いた後に湧いてくる）

### 手順
docker-compose.ymlを以下で作成する。どのopenjdkでも共通して使いまわせる。
```
version: '3.6'
services:
  java:
    build: ./docker/java
    ports:
      - 8080:8080
    tty: true
    volumes:
      - ./server/src:/usr/src:cached
```
Dockerfileを作成する。いろんなバージョンを検証する際に、1行目を変えるだけでOK。  
```
FROM openjdk:xx

RUN apt-get update
WORKDIR /usr/src
```
テストファイルを作成する。Mainクラスのみ。
```
public class Main {
    public static void main(String[] args) throws Exception {

        Integer number = null;
        try {
            System.out.println(number == 1);
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}
```
これで各種ファイルの準備が完了した。コマンドを叩いていく。
  
dockerをビルド
```
NobuhironoMacBook-Air:java-version-test-11 nobuhiro$ docker-compose build
[+] Building 2.7s (7/7) FINISHED                                                   
 => [internal] load build definition from Dockerfile                          0.0s
 => => transferring dockerfile: 355B                                          0.0s
 => [internal] load .dockerignore                                             0.0s
 => => transferring context: 2B                                               0.0s
 => [internal] load metadata for docker.io/library/openjdk:11                 2.5s
 => [1/3] FROM docker.io/library/openjdk:11@sha256:f305ff95f58d6567dc6c9c9fa  0.0s
 => CACHED [2/3] RUN apt-get update                                           0.0s
 => CACHED [3/3] WORKDIR /usr/src                                             0.0s
 => exporting to image                                                        0.0s
 => => exporting layers                                                       0.0s
 => => writing image sha256:5445460bbf75c1eae1386426b9655c04447e5ccd22e95334  0.0s
 => => naming to docker.io/library/java-version-test-11_java                  0.0s

Use 'docker scan' to run Snyk tests against images to find vulnerabilities and learn how to fix them
```
dockerをバックグラウンドで動かす
```
NobuhironoMacBook-Air:java-version-test-11 nobuhiro$ docker-compose up -d
[+] Running 2/2
 ⠿ Network java-version-test-11_default   Created                             0.1s
 ⠿ Container java-version-test-11-java-1  Started                             0.8s
```
コンテナを確認
```
NobuhironoMacBook-Air:java-version-test-11 nobuhiro$ docker-compose ps
NAME                          COMMAND             SERVICE             STATUS              PORTS
java-version-test-11-java-1   "jshell"            java                running             0.0.0.0:8080->8080/tcp
```
コンテナに入る
```
NobuhironoMacBook-Air:java-version-test-11 nobuhiro$ docker-compose exec java bash
```
バージョンを確認。今回は11。
```
root@68dc0b55208b:/usr/src# java -version
openjdk version "11.0.13" 2021-10-19
OpenJDK Runtime Environment 18.9 (build 11.0.13+8)
OpenJDK 64-Bit Server VM 18.9 (build 11.0.13+8, mixed mode, sharing)
```
コンパイル
```
root@68dc0b55208b:/usr/src# javac Main.java
```
実行結果の確認。ヌルポでした。
```
root@68dc0b55208b:/usr/src# java Main
java.lang.NullPointerException
	at Main.main(Main.java:6)
```

Dockerfileの1行目`FROM openjdk:xx`を書き換えて同様の検証をする。 
しかし、`FROM openjdk:10`のみ変更し、そのままbuildしようとしたら以下のエラーが発生。
```
NobuhironoMacBook-Air:java-version-test-10 nobuhiro$ docker-compose build
[+] Building 2.6s (5/6)                                                         
 => [internal] load build definition from Dockerfile                       0.0s
 => => transferring dockerfile: 255B                                       0.0s
 => [internal] load .dockerignore                                          0.0s
 => => transferring context: 2B                                            0.0s
 => [internal] load metadata for docker.io/library/openjdk:10              1.2s
 => CACHED [1/3] FROM docker.io/library/openjdk:10@sha256:9f17c917630d5e9  0.0s
 => ERROR [2/3] RUN apt-get update                                         1.1s
------                                                                          
 > [2/3] RUN apt-get update:                                                    
#5 0.700 Get:1 http://deb.debian.org/debian sid InRelease [165 kB]              
#5 0.967 Err:1 http://deb.debian.org/debian sid InRelease                       
#5 0.967   The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 648ACFD622F3D138 NO_PUBKEY 0E98404D386FA1D9
#5 0.975 Reading package lists...
#5 1.012 W: GPG error: http://deb.debian.org/debian sid InRelease: The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 648ACFD622F3D138 NO_PUBKEY 0E98404D386FA1D9
#5 1.012 E: The repository 'http://deb.debian.org/debian sid InRelease' is not signed.
------
failed to solve: rpc error: code = Unknown desc = executor failed running [/bin/sh -c apt-get update]: exit code: 100
```
ちょっと根本原因がわからない。暫定対応として、Dockerfileの`RUN apt-get update`を削除。

### 検証結果

openjdk:10 ヌルポ
```
root@a9436eae8ad8:/usr/src# java -version
openjdk version "10.0.2" 2018-07-17
OpenJDK Runtime Environment (build 10.0.2+13-Debian-2)
OpenJDK 64-Bit Server VM (build 10.0.2+13-Debian-2, mixed mode)

root@a9436eae8ad8:/usr/src# javac Main.java
root@a9436eae8ad8:/usr/src# java Main
java.lang.NullPointerException
	at Main.main(Main.java:6)
```

openjdk:9 ヌルポ
```
root@6f8d20144112:/usr/src# java -version
openjdk version "9.0.4"
OpenJDK Runtime Environment (build 9.0.4+12-Debian-4)
OpenJDK 64-Bit Server VM (build 9.0.4+12-Debian-4, mixed mode)

root@6f8d20144112:/usr/src# javac Main.java
root@6f8d20144112:/usr/src# java Main
java.lang.NullPointerException
	at Main.main(Main.java:6)
```

openjdk:8 ヌルポ
```
root@7205d398d86d:/usr/src# java -version
openjdk version "1.8.0_312"
OpenJDK Runtime Environment (build 1.8.0_312-b07)
OpenJDK 64-Bit Server VM (build 25.312-b07, mixed mode)

root@7205d398d86d:/usr/src# javac Main.java
root@7205d398d86d:/usr/src# java Main
java.lang.NullPointerException
	at Main.main(Main.java:6)
```

openjdk:7 ヌルポ
```
root@d92c366ed649:/usr/src# java -version
java version "1.7.0_221"
OpenJDK Runtime Environment (IcedTea 2.6.18) (7u221-2.6.18-1~deb8u1)
OpenJDK 64-Bit Server VM (build 24.221-b02, mixed mode)

root@d92c366ed649:/usr/src# javac Main.java
root@d92c366ed649:/usr/src# java Main
java.lang.NullPointerException
	at Main.main(Main.java:6)
```

openjdk:6 ヌルポ
```
root@912f14bfec1c:/usr/src# java -version
java version "1.6.0_38"
OpenJDK Runtime Environment (IcedTea6 1.13.10) (6b38-1.13.10-1~deb7u1)
OpenJDK 64-Bit Server VM (build 23.25-b01, mixed mode)

root@912f14bfec1c:/usr/src# javac Main.java
root@912f14bfec1c:/usr/src# java Main
java.lang.NullPointerException
	at Main.main(Main.java:6)
```