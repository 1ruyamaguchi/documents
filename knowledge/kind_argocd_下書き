SSOT (ä¿¡é ¼ã§ãã‚‹å”¯ä¸€ã®æƒ…å ±æº) ã®æ¦‚å¿µãŒé‡è¦è¦–ã•ã‚Œã‚‹æ˜¨ä»Šã€ç’°å¢ƒã®æ§‹æˆã‚’ã©ã“ã§ã€ã©ã®ã‚ˆã†ã«ç®¡ç†ã™ã‚‹ã‹ãŒå¤§ããªèª²é¡Œã¨ãªã£ã¦ã„ã¾ã™ã€‚
ä»Šå›ã¯ kind ã¨Argo CD ã‚’ç”¨ã„ã¦ã€Git ã®æƒ…å ±ã‚’çœŸã¨ã—ã¦ Kubernetes ä¸Šã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã€ç®¡ç†ã•ã‚Œã‚‹æ§˜å­ã‚’ä½“é¨“ã—ã¾ã™ã€‚ 

æ¦‚è¦
kind ã‚’ç”¨ã„ã¦ç–‘ä¼¼ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚ã•ã‚‰ã«ãã®ã‚¯ãƒ©ã‚¹ã‚¿ä¸Šã« Argo CD ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
Argo CD ã¯Git ã®ãƒªãƒã‚¸ãƒˆãƒªä¸Šã«ã‚ã‚‹Kubernetes ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›£è¦–ã—ã€è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã„ã¾ã™ã€‚

ãªã‚“ã‹ã‚ˆã•ã’ãªå›³ã‚’ã“ã“ã«æã

ãƒã‚·ãƒ³ã®æº–å‚™
ä»¥ä¸‹ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã€‚

docker (cf. https://docs.docker.com/engine/install/)
kind (cf. https://kind.sigs.k8s.io/docs/user/quick-start/#installation)
kubectl (cf. https://kubernetes.io/ja/docs/tasks/tools/install-kubectl/)
ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
first-java-deploy
 â”œâ”€docker
 â”‚  â””â”€image
 â”‚     â”œâ”€first-java-app_1.tar  #container imageã‚’å›ºã‚ãŸã‚‚ã®
 â”‚     â””â”€first-java-app_2.tar
 â””â”€kind
    â””â”€cluster
       â””â”€first-java-cluster.yaml  #ã‚¯ãƒ©ã‚¹ã‚¿èµ·å‹•ç”¨ã®yaml
Java ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æº–å‚™
Kubernetes ç’°å¢ƒã«ä¹—ã›ã‚‹ã€å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™ã ã‘ã®ç°¡å˜ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰ãˆã¦ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³1ã¨2ã‚’ç”¨æ„ã—ã¾ã™ã€‚

ã‚½ãƒ¼ã‚¹
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³1, 2å…±é€šï¼‰

SampleService.java ã‚½ãƒ¼ã‚¹ã‚’æŠ˜ã‚ŠãŸãŸã‚€
package com.example.kuberestapi.service;
 
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;
 
/**
 * ãƒ†ã‚¹ãƒˆç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚
 *
 */
@Service
@RestController
@RequestMapping("/kind")
public interface SampleService {
 
    /**
     * å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚
     *
     * @return
     */
    @RequestMapping(value = "/greet", method = RequestMethod.GET)
    String getMessage();
}
å®Ÿè£…ã‚¯ãƒ©ã‚¹ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³1ï¼‰"Hello, Argo CD!" ãŒè¿”ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

SampleServiceImpl.java ã‚½ãƒ¼ã‚¹ã‚’æŠ˜ã‚ŠãŸãŸã‚€
package com.example.kuberestapi.service.impl;
 
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
 
import com.example.kuberestapi.service.SampleService;
 
/**
 * ãƒ†ã‚¹ãƒˆç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
 *
 */
@Service
public class SampleServiceImpl implements SampleService {
 
    @Override
    public String getMessage() {
 
        String retMessage = "Hello, Argo CD!";
 
        Logger logger = LoggerFactory.getLogger(SampleServiceImpl.class);
        logger.info("Create the message {}", retMessage);
 
        return retMessage;
    }
}
å®Ÿè£…ã‚¯ãƒ©ã‚¹ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³2ï¼‰"Good bye, Argo CD!" ãŒè¿”ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

SampleServiceImpl.java ã‚½ãƒ¼ã‚¹ã‚’æŠ˜ã‚ŠãŸãŸã‚€
package com.example.kuberestapi.service.impl;
 
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
 
import com.example.kuberestapi.service.SampleService;
 
/**
 * ãƒ†ã‚¹ãƒˆç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
 *
 */
@Service
public class SampleServiceImpl implements SampleService {
 
    @Override
    public String getMessage() {
 
        String retMessage = "Good bye, Argo CD!";
 
        Logger logger = LoggerFactory.getLogger(SampleServiceImpl.class);
        logger.info("Create the message {}", retMessage);
 
        return retMessage;
    }
}
container image ã®ä½œæˆ
ã‚¢ãƒ—ãƒªã® container image ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ä½œæˆã—ã€tar ã§å›ºã‚ã¦ã‚µãƒ¼ãƒå´ã§å±•é–‹ã—ã¾ã™ã€‚

docker load < first-java-app_1.tar
docker load < first-java-app_2.tar
$ docker image ls | grep first-java-app
Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ã®æº–å‚™
ã‚¯ãƒ©ã‚¹ã‚¿ã®èµ·å‹•
ä»¥ä¸‹ã® yaml ã‚’ç”¨ã„ã¦ã‚¯ãƒ©ã‚¹ã‚¿ã‚’èµ·å‹•ã—ã¾ã™ã€‚

first-java-cluster.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30080
    hostPort: 30070
    protocol: TCP
  - containerPort: 30090
    hostPort: 30071
    protocol: TCP
- role: worker
- role: worker
ã‚¯ãƒ©ã‚¹ã‚¿å¤–å‘ã‘ã«é–‹ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒˆã«ã¤ã„ã¦ã€ä»¥ä¸‹ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

30070: Argo CD ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
30071: Java ã‚¢ãƒ—ãƒªã®APIã‚’å©ã
container image ã®èª­ã¿è¾¼ã¿
ã‚¯ãƒ©ã‚¹ã‚¿å†…ã« container image ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

kind load docker-image first-java-app:1 --name first-java-cluster
kind load docker-image first-java-app:2 --name first-java-cluster
ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ç®¡ç†ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®æº–å‚™
åˆ¥é€” GitLab ã‚µãƒ¼ãƒã‚’ç«‹ã¦ã¦ã€å„ç¨®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã—ã¾ã™ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ
first-java-app-project
 â””â”€k8s
    â”œâ”€first-java-deployment.yaml
    â””â”€first-java-service.yaml
å„ç¨®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ
first-java-deployment.yaml ã¯ container image ã‹ã‚‰ã‚¢ãƒ—ãƒªã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã€æ­»æ´»ç›£è¦–ã‚’ã—ã¾ã™ã€‚

first-java-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: first-java-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: first-java-app
  template:
    metadata:
      labels:
        app: first-java-app
    spec:
      containers:
      - name: first-java
        image: first-java-app:1
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
first-java-service.yaml ã¯ ã‚¯ãƒ©ã‚¹ã‚¿å†…å¤–ã®é€šä¿¡ã‚’ç®¡ç†ã—ã¾ã™ã€‚

first-java-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: first-java-service
spec:
  type: NodePort
  ports:
  - name: "java-port"
    port: 8099
    protocol: TCP
    targetPort: 8080
    nodePort: 30090
  selector:
    app: first-java-app
Argo CD ã‚’ä½¿ã£ã¦ã¿ã‚‹
Argo CD ã®èµ·å‹•
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—/åˆ‡ã‚Šæˆ»ã—
ä½™è«‡
container image ã®ç®¡ç†æ–¹æ³•ã«ã¤ã„ã¦
ã‚¢ãƒ—ãƒªã® container image ã«ã¤ã„ã¦ã€ä»Šå›ã¯ç°¡å˜ã®ãŸã‚ã«äº‹å‰ã«ä½œã£ãŸ image ã‚’ tar ã§å›ºã‚ã¦ã‚¯ãƒ©ã‚¹ã‚¿å†…ã«æŒã¡è¾¼ã¿ã¾ã—ãŸãŒã€å®Ÿéš›ã¯ Amazon ECR ãªã©ã‚’ä½¿ã£ã¦ç®¡ç†ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†æ–¹æ³•ã«ã¤ã„ã¦
ä»Šå›ã¯ GitLab ã‚µãƒ¼ãƒã‚’ç«‹ã¦ã¾ã—ãŸãŒã€GitHub ã§ã‚‚åŒæ§˜ã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ç®¡ç†ã—ã¦ Argo CD ã¨é€£æºã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è‡ªåˆ†ãŸã¡ã§ç®¡ç†ã™ã‚‹ã‚µãƒ¼ãƒãŒæ¸›ã‚‹ã®ã§ã€ã“ã¡ã‚‰ã®æ–¹ãŒæ‰‹è»½ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

---

nob@kind:~$ docker image ls | grep first-java-app
first-java-app   2         83bba441f58a   19 minutes ago   492MB
first-java-app   1         29fb89005ccf   22 minutes ago   492MB

nob@kind:~/kind/cluster$ kind create cluster --name first-java-cluster --config first-java-cluster.yaml 
Creating cluster "first-java-cluster" ...
 âœ“ Ensuring node image (kindest/node:v1.24.0) ğŸ–¼ 
 âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
 âœ“ Joining worker nodes ğŸšœ 
Set kubectl context to "kind-first-java-cluster"
You can now use your cluster with:

kubectl cluster-info --context kind-first-java-cluster

Not sure what to do next? ğŸ˜…  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
